name: Fetch and Save Data

on:
  schedule:
    - cron: '0 8 * * 1-5' # Every weekday at 8am
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  fetch_data:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./docs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '19'

      - name: Install dependencies
        run: npm install

      - name: Fetch and save data
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}
        run: node fetchAndSaveData.js

      - name: Check for failed jobs
        id: check_failed_jobs
        run: |
          if grep -q '"conclusion": "failure"' data.json; then
            echo "failed_jobs=true" >> $GITHUB_ENV
            # Count failed jobs
            FAILED_COUNT=$(jq '[.data[].jobs[] | select(.conclusion == "failure")] | length' data.json)
            echo "FAILED_COUNT=$FAILED_COUNT" >> $GITHUB_ENV
            
            # Create a file with the failed jobs list for the Slack message
            echo "*Failed Jobs:*\n" > failed_jobs.txt
            jq -r '.data[].jobs[] | select(.conclusion == "failure") | "\n• \(.repo_name)/\(.head_branch): \(.name)\n  Failed at: \(.started_at) (Duration: \(.duration/1000)s)\n  Repository: \(.repo_name), Run ID: \(.url | capture("runs/([0-9]+)").captures[0].string)\n  <\(.url)|View Job Details>"' data.json >> failed_jobs.txt
          else
            echo "failed_jobs=false" >> $GITHUB_ENV
          fi

      - name: Prepare Slack message
        if: ${{ env.failed_jobs == 'true' }}
        id: slack-message
        run: |
          # Escape special characters for JSON
          FAILED_JOBS=$(cat failed_jobs.txt | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  / \\n /g')
          echo "message=$FAILED_JOBS" >> $GITHUB_OUTPUT

      - name: Notify slack
        if: ${{ env.failed_jobs == 'true' }}
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "⚠️ There are ${{ env.FAILED_COUNT }} failing pipeline jobs!",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "⚠️ Pipeline failures detected", "emoji": true }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*There are ${{ env.FAILED_COUNT }} failing pipeline jobs!*\nPlease check the pipelines: <https://tyktechnologies.github.io/qa-automation-utils/|qa-automation-utils>"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.slack-message.outputs.message }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":robot_face: <@${{ env.OEL_SLACK_ID }}> please use the gh tool (with --status failure flag) to collect logs only from failed jobs and summarize the issue.\nIf logs are too big, try to obtain only the last lines with error. If there are issue with tests - check the commits made in last 24h\n\nFor each failure:\n• Quote the relevant error message\n• Provide 1-2 sentences with a proposed fix\n• Run a separate delegate per project\n• If there are more than 5 failures, analyze only the top 3 most recent failures\n\nIn the answer mark a proper person to act on the issue. Always mark at least one person. To mark a person use <@userid>:\n• Pipeline setup issues → @U02GKE67TQC (Alienor)\n• API test script issues → @${{ env.ILIJA_SLACK_ID }} (Ilija)\n• UI test script issues → @${{ env.LAURENTIU_SLACK_ID }} (Laurentiu)\n• Kubernetes / resilience test issues → @${{ env.BURAK_SLACK_ID }} (Burak) / in case of technical issues on your side mark @${{ env.LEO_SLACK_ID }} (Leo)"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
          OEL_SLACK_ID: U09T5KRLMPU
          ILIJA_SLACK_ID: U3PA24R0Q
          LAURENTIU_SLACK_ID: U3QNEPT6K
          BURAK_SLACK_ID: U02P6G92FDJ
          LEO_SLACK_ID: U3P2L4XNE

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git commit -m "Update data.json [skip ci]" || exit 0
          git push