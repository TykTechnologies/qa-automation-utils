name: Fetch and Save Data

on:
  schedule:
    - cron: '0 8 * * 1-5' # Every weekday at 8am
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  fetch_data:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./docs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '19'

      - name: Install dependencies
        run: npm install

      - name: Fetch and save data
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}
        run: node fetchAndSaveData.js

      - name: Check for failed jobs
        id: check_failed_jobs
        run: |
          if grep -q '"conclusion": "failure"' data.json; then
            echo "failed_jobs=true" >> $GITHUB_ENV
            # Count failed jobs
            FAILED_COUNT=$(jq '[.data[].jobs[] | select(.conclusion == "failure")] | length' data.json)
            echo "FAILED_COUNT=$FAILED_COUNT" >> $GITHUB_ENV
            
            # Create a file with the failed jobs list for the Slack message
            echo "*Failed Jobs:*\n" > failed_jobs.txt
            jq -r '.data[].jobs[] | select(.conclusion == "failure") | "\n• \(.repo_name)/\(.head_branch): \(.name)\n  Failed at: \(.started_at) (Duration: \(.duration/1000)s)\n  <\(.url)|View Job Details>"' data.json >> failed_jobs.txt
          else
            echo "failed_jobs=false" >> $GITHUB_ENV
          fi

      - name: Prepare Slack message
        if: ${{ env.failed_jobs == 'true' }}
        id: slack-message
        run: |
          # Escape special characters for JSON
          FAILED_JOBS=$(cat failed_jobs.txt | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  / \\n /g')
          echo "message=$FAILED_JOBS" >> $GITHUB_OUTPUT

      - name: Notify slack
        if: ${{ env.failed_jobs == 'true' }}
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "⚠️ *There are ${{ env.FAILED_COUNT }} failing pipeline jobs!*\n\nPlease check the pipelines: <https://tyktechnologies.github.io/qa-automation-utils/|link>\n\n${{ steps.slack-message.outputs.message }}\n\n:robot_face: <@${{ env.OEL_SLACK_ID }}> please use the gh tool to collect logs only from failed jobs and summarize the issue. If logs are too big try to obtain only the last lines with error. \nFor each failure:\n• Quote the relevant error message\n• Provide 1-2 sentences with a proposed fix\n• Run a separate delegate per project\n• If there more than 5 failures, analyze only the top 3 most recent failures\nYou can assign the issue to the appropriate person by mentioning them with @userid in the Slack message:\n• Pipeline setup issues → @alienor\n• API test script issues → @Ilija\n• UI test script issues → @Laurentiu\n• Kubernetes / resilience test issues → @Burak\n"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
          OEL_SLACK_ID: U09T5KRLMPU

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git commit -m "Update data.json [skip ci]" || exit 0
          git push